<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finance Department - Task Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Finance color palette */
    :root {
      --green-dark: #1e3a2f;
      --green-light: #4caf50;
      --blue-dark: #0b2545;
      --blue-light: #3a7ca5;
      --gray-dark: #2f2f2f;
      --gray-medium: #6b7280;
      --gray-light: #d1d5db;
      --black: #000000;
      --white: #ffffff;
    }

    .hidden {
      display: none;
    }
    .fade-in {
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    /* Custom scrollbar */
    .custom-scroll {
      max-height: 150px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--gray-dark) var(--gray-light);
    }
    .custom-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scroll::-webkit-scrollbar-track {
      background: var(--white);
    }
    .custom-scroll::-webkit-scrollbar-thumb {
      background: var(--gray-light);
      border-radius: 3px;
    }
    /* Calendar grid */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .day-cell {
      padding: 12px;
      border: 1px solid var(--gray-light);
      background: linear-gradient(135deg, var(--white), #f0fdfa);
      cursor: pointer;
      min-height: 70px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(26, 115, 83, 0.15);
      transition: transform 0.2s;
      color: var(--green-dark);
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .day-cell:hover {
      transform: scale(1.02);
      background: #d1fae5;
    }
    .day-cell.today {
      background: linear-gradient(135deg, var(--green-light), var(--green-dark));
      border: 2px solid var(--blue-dark);
      font-weight: 700;
      color: var(--white);
      box-shadow: 0 0 8px var(--green-light);
    }
    .day-cell.agenda {
      background: linear-gradient(135deg, #a7f3d0, #6ee7b7);
      border-color: var(--blue-dark);
      color: var(--blue-dark);
    }
    /* Task table */
    .task-table {
      width: 100%;
      border-collapse: collapse;
    }
    .task-table th,
    .task-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--gray-light);
      color: var(--gray-dark);
    }
    .task-table th {
      background: var(--blue-dark);
      color: var(--white);
    }
    /* Leaderboard progress bar */
    .progress-bar {
      background: var(--gray-light);
      border-radius: 10px;
      overflow: hidden;
      height: 20px;
      margin-top: 5px;
    }
    .progress-fill {
      height: 100%;
      background: var(--green-dark);
      transition: width 0.3s;
    }
    /* Modern gradients and shadows */
    .card {
      background: var(--white);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(14, 78, 54, 0.15);
    }
    .btn {
      border-radius: 8px;
      font-weight: bold;
      transition: all 0.3s;
      box-shadow: 0 4px 8px rgba(14, 78, 54, 0.4);
      background: var(--green-light);
      color: var(--white);
      cursor: pointer;
      user-select: none;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(14, 78, 54, 0.6);
      background: var(--green-dark);
    }
    .btn-red {
      background: #b91c1c;
      color: var(--white);
      box-shadow: 0 4px 8px rgba(185, 28, 28, 0.4);
    }
    .btn-red:hover {
      background: #7f1d1d;
      box-shadow: 0 6px 12px rgba(127, 29, 29, 0.6);
    }
    .btn-green {
      background: var(--green-dark);
      color: var(--white);
      box-shadow: 0 4px 8px rgba(14, 78, 54, 0.4);
    }
    .btn-green:hover {
      background: var(--green-light);
      box-shadow: 0 6px 12px rgba(14, 78, 54, 0.6);
    }
    .btn-blue {
      background: var(--blue-light);
      color: var(--white);
      box-shadow: 0 4px 8px rgba(10, 44, 82, 0.4);
    }
    .btn-blue:hover {
      background: var(--blue-dark);
      box-shadow: 0 6px 12px rgba(10, 44, 82, 0.6);
    }
    .btn-gray {
      background: var(--gray-light);
      color: var(--gray-dark);
      box-shadow: 0 4px 8px rgba(107, 114, 128, 0.4);
    }
    .btn-gray:hover {
      background: #9ca3af;
    }
    .header-bg {
      background: linear-gradient(135deg, var(--blue-dark), var(--green-dark));
      color: var(--white);
      box-shadow: 0 4px 12px rgba(14, 78, 54, 0.5);
    }
    .nav-bg {
      background: linear-gradient(135deg, var(--green-light), var(--blue-light));
      color: var(--white);
      box-shadow: inset 0 -2px 4px rgba(14, 78, 54, 0.3);
    }
    /* Alert styles */
    .alert {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .alert-error {
      background: #fee2e2;
      color: #b91c1c;
    }
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 0 15px;
      }
      .calendar-grid {
        grid-template-columns: repeat(1, 1fr);
      }
      .task-table {
        font-size: 14px;
      }
    }
    @media (max-width: 480px) {
      nav > div {
        flex-direction: column;
        align-items: center;
      }
      nav > div > button {
        width: 100%;
        margin-bottom: 8px;
      }
    }
    /* Leaderboard user image */
    .leaderboard-user-img {
      width: 40px;
      height: 40px;
      border-radius: 9999px;
      object-fit: cover;
      border: 1px solid var(--gray-light);
      margin-right: 0.75rem;
    }
    /* Agenda list flex for delete button */
    #agenda-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #agenda-list li button {
      margin-left: 0.5rem;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    /* Logo circle */
    #login-section img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      border: 4px solid var(--green-dark);
      box-shadow: 0 4px 12px rgba(14, 78, 54, 0.5);
    }
  </style>
</head>
<body class="bg-white font-sans min-h-screen flex flex-col">
  <header class="header-bg p-4 shadow-sm">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">Finance Department Task Monitor</h1>
      <button id="logout-btn" class="btn btn-red text-xs px-3 py-1 hidden" onclick="logout()">Logout</button>
    </div>
  </header>

  <div id="login-section" class="flex-grow flex items-center justify-center p-6">
    <div class="card w-full max-w-md text-center">
      <img
        src="logo.jpg"
        alt="Finance Department Logo"
        class="mx-auto mb-6 rounded-full"
      />
      <h2 class="text-xl font-semibold mb-4 text-green-dark">Login</h2>
      <input
        id="username-input"
        type="text"
        placeholder="Enter your name"
        class="w-full p-3 border border-gray-400 rounded mb-3 text-green-dark placeholder-gray-500"
      />
      <button onclick="login()" class="btn btn-blue w-full py-3">Login</button>
      <p id="login-error" class="alert-error hidden mt-3 text-sm"></p>
    </div>
  </div>

  <div id="app-section" class="flex-grow hidden">
    <nav class="nav-bg py-3">
      <div class="container mx-auto flex flex-wrap justify-center gap-2 px-4">
        <button
          id="tasks-tab"
          class="btn text-sm px-3 py-1 border-b-2 border-white flex-grow sm:flex-grow-0"
          onclick="setTab('tasks')"
        >
          Tasks
        </button>
        <button
          id="dashboard-tab"
          class="btn text-sm px-3 py-1 text-gray-300 flex-grow sm:flex-grow-0"
          onclick="setTab('dashboard')"
        >
          Dashboard
        </button>
        <button
          id="leaderboard-tab"
          class="btn text-sm px-3 py-1 text-gray-300 flex-grow sm:flex-grow-0"
          onclick="setTab('leaderboard')"
        >
          Leaderboard
        </button>
        <button
          id="calendar-tab"
          class="btn text-sm px-3 py-1 text-gray-300 flex-grow sm:flex-grow-0"
          onclick="setTab('calendar')"
        >
          Calendar
        </button>
        <button
          id="notes-tab"
          class="btn text-sm px-3 py-1 text-gray-300 flex-grow sm:flex-grow-0"
          onclick="setTab('notes')"
        >
          Notes
        </button>
      </div>
    </nav>

    <main class="container mx-auto p-4 flex-1">
      <div id="tasks-section" class="fade-in">
        <h2 class="text-3xl font-bold mb-6 text-green-dark">Tasks</h2>
        <div id="admin-task-controls" class="card mb-6 hidden">
          <h3 class="text-lg font-medium mb-4 text-green-dark">Add/Edit Task</h3>
          <input
            id="new-task-title"
            type="text"
            placeholder="Task Title"
            class="w-full p-2 border border-gray-400 rounded mb-2 text-green-dark"
          />
          <textarea
            id="new-task-desc"
            placeholder="Task Description (optional)"
            class="w-full p-2 border border-gray-400 rounded mb-3 text-green-dark"
            rows="3"
          ></textarea>
          <label for="task-assigned" class="block font-medium mb-1 text-green-dark">Assign to (users or teams):</label>
          <select id="task-assigned" multiple class="w-full p-2 border border-gray-400 rounded mb-3 text-green-dark" size="5">
            <!-- Options will be populated by JS -->
          </select>
          <button onclick="addTask()" class="btn btn-green px-4 py-2 mr-2">
            Add Task
          </button>
          <button
            onclick="saveEditTask()"
            class="btn btn-gray px-4 py-2 hidden"
            id="save-edit-btn"
          >
            Save Edit
          </button>
          <button
            onclick="cancelEdit()"
            class="btn btn-gray px-4 py-2 hidden"
            id="cancel-edit-btn"
          >
            Cancel Edit
          </button>
        </div>
        <div id="tasks-list" class="space-y-4"></div>
      </div>

      <div id="notes-section" class="hidden fade-in">
        <h2 class="text-3xl font-bold mb-6 text-green-dark">Notes / Reminders</h2>
        <div class="card">
          <textarea id="notes-textarea" rows="22" class="w-full p-4 border border-gray-400 rounded text-green-dark" placeholder="Write your notes or reminders here..."></textarea>
          <button onclick="saveNotes()" class="btn btn-blue mt-4 px-6 py-2">Save Notes</button>
          <p id="notes-save-msg" class="text-green-700 mt-2 hidden">Notes saved!</p>
        </div>
      </div>

      <div id="dashboard-section" class="hidden fade-in">
        <h2 class="text-3xl font-bold mb-6 text-green-dark">Dashboard</h2>
        <div id="recent-completions" class="card space-y-3"></div>
      </div>

      <div id="leaderboard-section" class="hidden fade-in">
        <h2 class="text-3xl font-bold mb-6 text-green-dark">Leaderboard</h2>
        <div id="leaderboard-list" class="space-y-4"></div>
      </div>

      <div id="calendar-section" class="hidden fade-in">
        <h2 class="text-3xl font-bold mb-6 text-green-dark">Calendar</h2>
        <div class="flex justify-between items-center mb-4">
          <button onclick="changeMonth(-1)" class="btn btn-blue px-3 py-1">
            &larr;
          </button>
          <span id="calendar-title" class="text-lg font-semibold text-green-dark"></span>
          <button onclick="changeMonth(1)" class="btn btn-blue px-3 py-1">
            &rarr;
          </button>
        </div>
        <div id="calendar-grid" class="calendar-grid mb-4"></div>
        <div id="agenda-controls" class="card hidden">
          <h3 class="text-lg font-medium mb-4 text-green-dark">Add Agenda</h3>
          <input
            type="date"
            id="agenda-date"
            class="p-2 border border-gray-400 rounded mb-3 text-green-dark"
          />
          <input
            id="agenda-text"
            type="text"
            placeholder="Agenda Description"
            class="p-2 border border-gray-400 rounded mb-3 mr-2 text-green-dark"
          />
          <button onclick="addAgenda()" class="btn btn-blue px-4 py-2">
            Add Agenda
          </button>
        </div>
        <div id="agenda-display" class="card hidden">
          <h3 class="text-xl font-semibold mb-4 text-green-dark">
            Agenda for <span id="agenda-date-display"></span>
          </h3>
          <ul
            id="agenda-list"
            class="list-disc list-inside custom-scroll space-y-1"
          ></ul>
        </div>
      </div>
    </main>
  </div>

  <footer class="bg-gray-100 p-4 mt-8 border-t border-gray-300">
    <div class="container mx-auto text-center text-gray-600">
      <p>© 2025 Finance Department. All rights reserved.</p>
    </div>
  </footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
  // Firebase config and initialization
  const firebaseConfig = {
    apiKey: "AIzaSyBWlatSJVMVB1bfLcm_KIMW8G--jrq3jk0",
  authDomain: "finance-2b0c7.firebaseapp.com",
  projectId: "finance-2b0c7",
  storageBucket: "finance-2b0c7.firebasestorage.app",
  messagingSenderId: "503746748031",
  appId: "1:503746748031:web:a58422292ca26ffddd294a",
  measurementId: "G-XSPYK0FX7S"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Fixed data
  const users = [
    { username: "jeff", isAdmin: true, image: "images/users/jeff.jpg" },
    { username: "rain", isAdmin: false, image: "images/users/rain.jpg" },
    { username: "venice", isAdmin: false, image: "images/users/venice.jpg" },
    { username: "mark", isAdmin: false, image: "images/users/mark.jpg" },
    { username: "julie", isAdmin: true, image: "images/users/julie.jpg"},
    { username: "rj", isAdmin: true, image: "images/users/rj.jpg" },
    { username: "gerardo", isAdmin: false, image: "images/users/gerardo.jpg" },
  ];

  const teams = {
    auditor: ["gerardo"],
    "finance assistant": ["rain", "venice"],
    "finance relations manager": ["rj"],
    "finance relations assistant": ["julie"],
  };

  // App state
  let currentUser  = null;
  let tasks = [];
  let agendas = {}; // agendas for loaded dates
  let currentTab = "tasks";
  let currentMonth = new Date();
  let selectedDate = null;

  // Firestore listeners unsubscribe functions
  let unsubscribeTasksListener = null;
  let unsubscribeAgendaListener = null;
  let unsubscribeNotesListener = null;

  // Initialize app
  function init() {
    const storedUsername = localStorage.getItem("username");
    if (storedUsername) {
      currentUser  = users.find(u => u.username === storedUsername.toLowerCase());
      if (currentUser ) {
        showApp();
        setTab("tasks");
        startTasksListener();
        startNotesListener();
      } else {
        localStorage.removeItem("username");
      }
    }
  }

  // Start real-time listener for tasks collection
  function startTasksListener() {
    if (unsubscribeTasksListener) unsubscribeTasksListener();
    unsubscribeTasksListener = db.collection("tasks")
      .onSnapshot(snapshot => {
        tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        loadTasks();
        loadLeaderboard();
        loadDashboard();
      }, error => {
        console.error("Tasks listener error:", error);
      });
  }

  // Start real-time listener for notes document
  function startNotesListener() {
    if (unsubscribeNotesListener) unsubscribeNotesListener();
    unsubscribeNotesListener = db.collection("shared").doc("notes")
      .onSnapshot(doc => {
        const notes = doc.exists ? doc.data().text || "" : "";
        const textarea = document.getElementById("notes-textarea");
        textarea.value = notes;
        document.getElementById("notes-save-msg").classList.add("hidden");
        const saveBtn = document.querySelector("#notes-section button");
        if (currentUser .isAdmin) {
          textarea.removeAttribute("disabled");
          saveBtn.style.display = "inline-block";
        } else {
          textarea.setAttribute("disabled", "disabled");
          saveBtn.style.display = "none";
        }
      }, error => {
        console.error("Notes listener error:", error);
      });
  }

  // Start real-time listener for agendas of a specific date
  function startAgendaListener(date) {
    if (unsubscribeAgendaListener) unsubscribeAgendaListener();
    unsubscribeAgendaListener = db.collection("agendas").doc(date)
      .onSnapshot(doc => {
        agendas[date] = doc.exists ? doc.data().items || [] : [];
        showAgendas(date);
        renderCalendar();
      }, error => {
        console.error("Agenda listener error:", error);
      });
  }

  // Login function
  function login() {
    const usernameInput = document.getElementById("username-input");
    const username = usernameInput.value.trim().toLowerCase();
    const errorEl = document.getElementById("login-error");
    currentUser  = users.find(u => u.username === username);
    if (currentUser ) {
      localStorage.setItem("username", currentUser .username);
      showApp();
      setTab("tasks");
      startTasksListener();
      startNotesListener();
      errorEl.classList.add("hidden");
    } else {
      errorEl.textContent = "Invalid username. Please enter a valid name.";
      errorEl.classList.remove("hidden");
    }
  }

  // Logout function
  function logout() {
    localStorage.removeItem("username");
    currentUser  = null;
    hideApp();
    setTab("tasks");
    document.getElementById("username-input").value = "";
    document.getElementById("login-error").classList.add("hidden");
    if (unsubscribeTasksListener) unsubscribeTasksListener();
    if (unsubscribeNotesListener) unsubscribeNotesListener();
    if (unsubscribeAgendaListener) unsubscribeAgendaListener();
  }

  // Show app UI after login
  function showApp() {
    document.getElementById("login-section").classList.add("hidden");
    document.getElementById("app-section").classList.remove("hidden");
    document.getElementById("logout-btn").classList.remove("hidden");
    document.getElementById("admin-task-controls").classList.toggle("hidden", !currentUser .isAdmin);
    if (currentUser .isAdmin) {
      populateAssignmentOptions();
    }
  }

  // Hide app UI on logout
  function hideApp() {
    document.getElementById("app-section").classList.add("hidden");
    document.getElementById("login-section").classList.remove("hidden");
    document.getElementById("logout-btn").classList.add("hidden");
  }

  // Populate assignment options for tasks (users and teams)
  function populateAssignmentOptions() {
    const select = document.getElementById("task-assigned");
    select.innerHTML = "";
    users.forEach(u => {
      const option = document.createElement("option");
      option.value = u.username;
      option.textContent = `:User   ${u.username}`;
      select.appendChild(option);
    });
    Object.keys(teams).forEach(team => {
      const option = document.createElement("option");
      option.value = `team:${team}`;
      option.textContent = `Team: ${team}`;
      select.appendChild(option);
    });
  }

  // Check if current user is assigned to a task
  function isUserAssigned(task) {
    if (!task.assignedTo || task.assignedTo.length === 0) return true; // visible to all
    if (task.assignedTo.includes(currentUser .username)) return true;
    for (const assign of task.assignedTo) {
      if (assign.startsWith("team:")) {
        const teamName = assign.slice(5);
        if (teams[teamName] && teams[teamName].includes(currentUser .username)) {
          return true;
        }
      }
    }
    return false;
  }

  // Load and render tasks list
  function loadTasks() {
    const tasksList = document.getElementById("tasks-list");
    const visibleTasks = tasks.filter(isUser.Assigned);
    tasksList.innerHTML = visibleTasks.length
      ? visibleTasks.map(task => `
        <div class="card">
          <h3 class="text-xl font-semibold text-green-dark mb-2">${task.title}</h3>
          <p class="text-gray-600 mb-3">${task.description || "No description"}</p>
          <p class="text-sm text-gray-600 mb-3">Completed by: <span class="font-medium">${task.doneBy.length ? task.doneBy.join(", ") : "None"}</span></p>
          <p class="text-sm text-gray-600 mb-3">Assigned to: <span class="font-medium">${formatAssignedTo(task.assignedTo)}</span></p>
          <div class="flex flex-wrap gap-2">
            ${currentUser .isAdmin ? `
              <button onclick="editTask('${task.id}')" class="btn btn-gray">Edit</button>
              <button onclick="deleteTask('${task.id}')" class="btn btn-red">Delete</button>
            ` : ""}
            ${!task.doneBy.includes(currentUser .username)
              ? `<button onclick="markDone('${task.id}')" class="btn btn-green">Mark as Done</button>`
              : '<span class="text-green-600 font-semibold">✔ Completed</span>'
            }
          </div>
        </div>
      `).join("")
      : '<p class="text-gray-600">No tasks assigned to you.</p>';
    document.getElementById("admin-task-controls").classList.toggle("hidden", !currentUser .isAdmin);
  }

  // Format assignedTo array for display
  function formatAssignedTo(assignedTo) {
    if (!assignedTo || assignedTo.length === 0) return "All users";
    return assignedTo.map(a => a.startsWith("team:") ? `Team: ${a.slice(5)}` : `:User   ${a}`).join(", ");
  }

  // Add new task to Firestore
  function addTask() {
    const title = document.getElementById("new-task-title").value.trim();
    const desc = document.getElementById("new-task-desc").value;
    const assignedSelect = document.getElementById("task-assigned");
    const assignedTo = Array.from(assignedSelect.selectedOptions).map(o => o.value);
    if (!title) {
      alert("Task title is required.");
      return;
    }
    const newTask = {
      title,
      description: desc,
      doneBy: [],
      timestamps: {},
      assignedTo
    };
    db.collection("tasks").add(newTask)
      .then(() => {
        document.getElementById("new-task-title").value = "";
        document.getElementById("new-task-desc").value = "";
        assignedSelect.selectedIndex = -1;
        setTab("dashboard");
      })
      .catch(err => alert("Failed to add task: " + err.message));
  }

  // Edit task: populate form with task data
  function editTask(id) {
    const task = tasks.find(t => t.id === id);
    if (!task) return;
    document.getElementById("new-task-title").value = task.title;
    document.getElementById("new-task-desc").value = task.description;
    const assignedSelect = document.getElementById("task-assigned");
    Array.from(assignedSelect.options).forEach(option => {
      option.selected = task.assignedTo && task.assignedTo.includes(option.value);
    });
    document.getElementById("save-edit-btn").classList.remove("hidden");
    document.getElementById("save-edit-btn").setAttribute("data-id", id);
    document.getElementById("cancel-edit-btn").classList.remove("hidden");
  }

  // Save edited task to Firestore
  function saveEditTask() {
    const id = document.getElementById("save-edit-btn").getAttribute("data-id");
    const title = document.getElementById("new-task-title").value.trim();
    const desc = document.getElementById("new-task-desc").value;
    const assignedSelect = document.getElementById("task-assigned");
    const assignedTo = Array.from(assignedSelect.selectedOptions).map(o => o.value);
    if (!title) {
      alert("Task title is required.");
      return;
    }
    const task = tasks.find(t => t.id === id);
    if (!task) return;
    task.title = title;
    task.description = desc;
    task.assignedTo = assignedTo;
    db.collection("tasks").doc(id).set(task)
      .then(() => cancelEdit())
      .catch(err => alert("Failed to save task: " + err.message));
  }

  // Cancel editing task
  function cancelEdit() {
    document.getElementById("new-task-title").value = "";
    document.getElementById("new-task-desc").value = "";
    const assignedSelect = document.getElementById("task-assigned");
    Array.from(assignedSelect.options).forEach(option => option.selected = false);
    document.getElementById("save-edit-btn").classList.add("hidden");
    document.getElementById("cancel-edit-btn").classList.add("hidden");
    document.getElementById("save-edit-btn").removeAttribute("data-id");
  }

  // Delete task from Firestore
  function deleteTask(id) {
    if (confirm("Are you sure you want to delete this task?")) {
      db.collection("tasks").doc(id).delete()
        .catch(err => alert("Failed to delete task: " + err.message));
    }
  }

  // Mark task as done by current user
  function markDone(id) {
    const task = tasks.find(t => t.id === id);
    if (!task) return;
    if (!task.doneBy.includes(currentUser .username)) {
      task.doneBy.push(currentUser .username);
      task.timestamps = task.timestamps || {};
      task.timestamps[currentUser .username] = new Date().toISOString();
      db.collection("tasks").doc(id).set(task)
        .catch(err => alert("Failed to mark done: " + err.message));
    }
  }

  // Load dashboard recent completions
  function loadDashboard() {
    let completions = [];
    tasks.forEach(task => {
      if (task.doneBy && task.timestamps) {
        for (const user of task.doneBy) {
          completions.push({
            username: user,
            taskTitle: task.title,
            timestamp: task.timestamps[user],
          });
        }
      }
    });
    completions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    const recent = completions.slice(0, 10);
    const container = document.getElementById("recent-completions");
    container.innerHTML = recent.length
      ? recent.map(c => `
        <div class="bg-green-50 p-3 rounded border border-green-200">
          <p class="font-medium text-green-dark">${c.username}</p>
          <p class="text-gray-600">Completed "${c.taskTitle}"</p>
          <p class="text-xs text-gray-600">at ${formatTime(c.timestamp)}</p>
        </div>
      `).join("")
      : '<p class="text-gray-600">No recent task completions.</p>';
  }

  // Format ISO timestamp to local string
  function formatTime(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    return d.toLocaleString();
  }

  // Load leaderboard
  function loadLeaderboard() {
    const total = tasks.length;
    const container = document.getElementById("leaderboard-list");
    if (total === 0) {
      container.innerHTML = '<div class="text-center text-gray-600">No tasks available for leaderboard.</div>';
      return;
    }
    const leaderboard = users.map(u => {
      const doneCount = tasks.filter(t => t.doneBy && t.doneBy.includes(u.username)).length;
      const percent = ((doneCount / total) * 100).toFixed(2);
      return { user: u, percent: parseFloat(percent) };
    }).sort((a, b) => b.percent - a.percent);
    container.innerHTML = leaderboard.map((l, i) => `
      <div class="card flex items-center justify-between">
        <div class="flex items-center">
          <span class="text-lg font-bold text-green-dark mr-3">${i + 1}</span>
          <img src="${l.user.image}" alt="${l.user.username}" class="leaderboard-user-img" />
          <span class="font-medium text-green-dark">${l.user.username}</span>
          ${l.user.isAdmin ? '<span class="ml-2 px-2 py-1 bg-gray-200 text-gray-600 text-xs rounded-full">Admin</span>' : ''}
        </div>
        <div class="text-right min-w-0 flex-1">
          <div class="font-semibold text-green-dark">${l.percent}%</div>
          <div class="progress-bar w-full max-w-32">
            <div class="progress-fill" style="width: ${Math.min(l.percent, 100)}%"></div>
          </div>
        </div>
      </div>
    `).join("");
  }

  // Calendar rendering and agenda controls
  function loadCalendar() {
    renderCalendar();
    toggleAgendaControls(!currentUser .isAdmin);
  }

  function renderCalendar() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const title = currentMonth.toLocaleString("default", { month: "long", year: "numeric" });
    document.getElementById("calendar-title").textContent = title;
    const firstDay = new Date(year, month, 1).getDay();
    const lastDay = new Date(year, month + 1, 0).getDate();
    const grid = [];
    for (let i = 0; i < firstDay; i++) grid.push("");
    for (let d = 1; d <= lastDay; d++) grid.push(d.toString());
    const today = new Date();
    const todayDate = today.getDate();
    const todayMonth = today.getMonth();
    const todayYear = today.getFullYear();
    const monthStr = (month + 1).toString().padStart(2, "0");
    document.getElementById("calendar-grid").innerHTML = grid.map(day => {
      if (!day) return '<div class="day-cell"></div>';
      const d = parseInt(day);
      const dateStr = `${year}-${monthStr}-${d.toString().padStart(2, "0")}`;
      const hasAgenda = agendas[dateStr] && agendas[dateStr].length > 0;
      const isToday = d === todayDate && month === todayMonth && year === todayYear;
      return `
        <div class="day-cell ${isToday ? "today" : ""} ${hasAgenda ? "agenda" : ""}" onclick="selectDate('${dateStr}')">
          <div class="font-medium text-green-dark">${d}</div>
          ${hasAgenda ? `<div class="w-2 h-2 bg-green-700 rounded-full mt-2 mx-auto" title="Agenda scheduled"></div>` : ""}
        </div>
      `;
    }).join("");
  }

  function changeMonth(delta) {
    currentMonth.setMonth(currentMonth.getMonth() + delta);
    renderCalendar();
  }

  // Select date and load agendas for that date
  function selectDate(date) {
    selectedDate = date;
    startAgendaListener(date);
    if (currentUser .isAdmin) {
      document.getElementById("agenda-date").value = date;
      document.getElementById("agenda-controls").classList.remove("hidden");
    } else {
      document.getElementById("agenda-controls").classList.add("hidden");
    }
    document.getElementById("agenda-display").classList.remove("hidden");
  }

  // Show agendas for selected date
  function showAgendas(date) {
    document.getElementById("agenda-date-display").textContent = date;
    const list = document.getElementById("agenda-list");
    list.innerHTML = "";
    if (agendas[date] && agendas[date].length > 0) {
      agendas[date].forEach((agenda, idx) => {
        const li = document.createElement("li");
        li.textContent = agenda;
        if (currentUser .isAdmin) {
          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.className = "btn btn-red px-2 py-1 text-xs ml-2";
          delBtn.onclick = () => deleteAgenda(date, idx);
          li.appendChild(delBtn);
        }
        list.appendChild(li);
      });
    } else {
      list.innerHTML = `<li class="text-gray-600">No agendas scheduled.</li>`;
    }
  }

  // Add agenda item to Firestore for selected date
  function addAgenda() {
    const date = document.getElementById("agenda-date").value;
    const text = document.getElementById("agenda-text").value.trim();
    if (!date || !text) {
      alert("Please provide a date and agenda description.");
      return;
    }
    const agendaRef = db.collection("agendas").doc(date);
    agendaRef.get().then(doc => {
      let items = doc.exists ? doc.data().items || [] : [];
      items.push(text);
      return agendaRef.set({ items });
    }).then(() => {
      document.getElementById("agenda-text").value = "";
      // Refresh agendas and calendar
      startAgendaListener(date);
      renderCalendar();
      setTab("dashboard");
    }).catch(err => alert("Failed to add agenda: " + err.message));
  }

  // Delete agenda item from Firestore for selected date
  function deleteAgenda(date, index) {
    if (!confirm("Are you sure you want to delete this agenda item?")) return;
    const agendaRef = db.collection("agendas").doc(date);
    agendaRef.get().then(doc => {
      if (!doc.exists) return;
      let items = doc.data().items || [];
      items.splice(index, 1);
      if (items.length === 0) {
        return agendaRef.delete();
      } else {
        return agendaRef.set({ items });
      }
    }).catch(err => alert("Failed to delete agenda: " + err.message));
  }

  // Toggle agenda controls visibility
  function toggleAgendaControls(hide) {
    document.getElementById("agenda-controls").classList.toggle("hidden", hide);
    document.getElementById("agenda-display").classList.toggle("hidden", true);
  }

  // Save notes to Firestore
  function saveNotes() {
    if (!currentUser  || !currentUser .isAdmin) return;
    const notes = document.getElementById("notes-textarea").value;
    db.collection("shared").doc("notes").set({ text: notes })
      .then(() => {
        const msg = document.getElementById("notes-save-msg");
        msg.classList.remove("hidden");
        setTimeout(() => msg.classList.add("hidden"), 2000);
      })
      .catch(err => alert("Failed to save notes: " + err.message));
  }

  // Load notes handled by real-time listener in startNotesListener()

  // Load content for selected tab
  function loadTabContent(tab) {
    if (tab === "tasks") loadTasks();
    else if (tab === "dashboard") loadDashboard();
    else if (tab === "leaderboard") loadLeaderboard();
    else if (tab === "calendar") loadCalendar();
    else if (tab === "notes") {
      // Notes content is updated by listener, just ensure UI state
      const textarea = document.getElementById("notes-textarea");
      const saveBtn = document.querySelector("#notes-section button");
      if (currentUser  && currentUser .isAdmin) {
        textarea.removeAttribute("disabled");
        saveBtn.style.display = "inline-block";
      } else {
        textarea.setAttribute("disabled", "disabled");
        saveBtn.style.display = "none";
      }
    }
  }

  // Set active tab and update UI
  function setTab(tab) {
    currentTab = tab;
    const sections = ["tasks", "dashboard", "leaderboard", "calendar", "notes"];
    sections.forEach(s => {
      document.getElementById(s + "-section").classList.toggle("hidden", s !== tab);
      const btn = document.getElementById(s + "-tab");
      if (s === tab) {
        btn.classList.add("border-b-2", "border-white");
        btn.classList.remove("text-gray-300");
      } else {
        btn.classList.remove("border-b-2", "border-white");
        btn.classList.add("text-gray-300");
      }
    });
    loadTabContent(tab);
  }

  // Initialize app on page load
  window.onload = init;
</script>
</body>
</html>
